sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: Rv/F1OmgzpvR7fcReNWs4zWOQ3Xzjq1YER+TtUkx2hEplgGOA55RxOSr7z2jdzzNwjaT/sQr4msOv7uPzHZYpOQCs4QcZadsWOI4lfPut/t5Y/dFPJl27RC4ppBRw/3J79iYzyEDBXqrrgKq+rC2uzpBixRnl/zNXQ7KR9J5PgDcakCGTrO82aymtzXOhI9YQUMgxkyTDxtJ6wykTEpI0MnWPwfMNkYX5Tq1CNIqmFYR/UqoFS1YZf9/I7sY1Zx1HjTH9eKefbtAuWBkv94KatsuUMfbBnTq504vgFO/3BAEgq3N39EzBVdviOQqyit1nQyLb/7bbxoUvwZQnJxtVsf/Tx5xWGqoB4cMtDrObSc/wsWhcS+0nw0169p+2PDQRB/FVnceZ9zO2p7Vk4jBhmV4Fz0+gC2Hj03aDs9PVHmaPV7P6U26qz0iKe7Nihyc+0PZ+Lux/uU2ruFAq277TyUuv+ZfpEqus41jWDYQ8I/WRkmJlm390B/JMoa35RLkqOKUBpB+3sLB+eS6Wj8hC9IAbMsR68R7svSJWWoQU0TNnwRBH/i7F9JEmSjrhZwf6Ibl4yNxUJQOk6yi8D8FXxHKHEAs4pfFNDHQqDe/G/6FaduDS1OEbxG/w3Fr5edNUgkxS6hQeI/4NIxM7GgX4cLdfV7VPulAaLmCSQhD5cI=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/The-Railroad-Builders--A-Chronicle-of-the-Welding-of-the-States_3036
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy